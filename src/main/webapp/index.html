<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="js/jquery-1.11.3.min.js"></script>
<!--
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha3.js"></script>  
-->
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
 
<script>
	var login_email = undefined;
	var login_token = undefined;
	
	$(document).ready(function() {
        show_logininfo();
    	get_list();
        
    	if (login_token == undefined) {
    		$('#add_button').attr("disabled", true);
    	} else {
    		$('#add_button').attr("disabled", false);
    	}
    	$('#add_button').click(function() {
    		add_example();        	
    	});

        $('#search_button').click(function() {
        	get_list($('#search_text').val());
        });
        
        $('#list_button').click(function() {
        	get_list();        	
        });
        
	});

	// get list function
	function get_list(search) {
		show();
		
    	var search_url = "/associations/rest/list";
    	if (search != null) {
    		search_url += ("?search=" + search);
    	} 

        $.get(search_url, function(data, status) {
            var list = $.parseJSON(data);
            
    		var $table = $('<table border=0/>');    		
			$table.append('<tr><td></td><td></td><td>ID</td><td>Name</td><td>Telf.</td></tr>');
            for(var i =0; i<list.length; i++) {
            	if (login_token == undefined) {
            		edit_url = '<button disabled>edit</button>';
            		delete_url = '<button disabled>delete</button>';
            	} else {
            		edit_url = '<button onClick="void(edit_example(\'' + list[i].id + '\'));">edit</button>';
            		delete_url = '<button onClick="void(delete_example(\'' + list[i].id + '\'));">delete</button>';
            	}
    			$table.append('<tr><td>' + edit_url + '</td><td>' + delete_url + '</td><td>' + list[i].id + '</td><td>' + list[i].name + '</td><td>' + list[i].telf + '</td></tr>');
            }
    		$('#list').html($table);
    	});		
	}
	
	// add example function
	function add_example() {
		hide();
		
		var $table = $('<table border=0/>');    		
		//$table.append('<tr><td>ID</td><td><input id="id_text" type="text" name="id" size="10"></td></tr>');
		$table.append('<tr><td>Name</td><td><input id="name_text" type="text" name="name" size="20"></td></tr>');
		$table.append('<tr><td>Telf.</td><td><input id="telf_text" type="text" name="telf" size="20"></td></tr>');
		$table.append('<tr><td colspan="2"><button id="submit_button">add example</button></td></tr>');	
		$('#list').html($table);
		
		$('#submit_button').click(function() {
			var url = "/associations/rest/add";
			var posting = $.post(url, { name: $('#name_text').val(), telf: $('#telf_text').val() } );
			posting.done(function(data) {
				alert(data);
				get_list();
			});
        });
	}
	
	// delete example function
	function delete_example(id) {
		var delete_url = "/associations/rest/delete?id=" + id;		
		$.ajax({
		    url: delete_url,
		    type: 'DELETE',
		    success: function(result) {
				alert(result);
				get_list();		    	
		    }
		});
	}

	// edit example function
	function edit_example(id) {
    	var get_url = "/associations/rest/get?id=" + id;

        $.get(get_url, function(data, status) {
            var example = $.parseJSON(data);

    		var $table = $('<table border=0/>');    		
    		$table.append('<tr><td>ID</td><td><input id="id_text" type="text" name="id" size="10" value="' + example.id + '" disabled></td></tr>');
    		$table.append('<tr><td>Name</td><td><input id="name_text" type="text" name="name" size="20" value="' + example.name + '"></td></tr>');
    		$table.append('<tr><td>Telf.</td><td><input id="telf_text" type="text" name="telf" size="20" value="' + example.telf + '"></td></tr>');
    		$table.append('<tr><td colspan="2"><button id="submit_button">update example</button></td></tr>');	
    		$('#list').html($table);

    		$('#submit_button').click(function() {
    			var edit_url = "/associations/rest/edit";
    			$.ajax({
    		    	url: edit_url,
    		    	type: 'PUT',
    		    	data: { id: example.id, name: $('#name_text').val(), telf: $('#telf_text').val() },
    		    	success: function(result) {
    					alert(result);
    					get_list();		    	
    		    	}
    			});
    		});
    	});				
	}

	// display login info
	function show_logininfo() {
    	if (login_token == undefined) {
    		$('#login_info').html('<button id="login_button">login</button>');
            $('#login_button').click(function() {
            	login_user();        	
            });
		} else {
    		$('#login_info').html(login_email + '&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<button id="logout_button">logout</button>');
            $('#logout_button').click(function() {
				login_token = undefined;
				login_email = undefined;
	    		$('#add_button').attr("disabled", true);
				get_list();
				show_logininfo();
            });
		}
		$('#login_info').show();
	}
	
	// login an user
	function login_user() {
		hide();
		$('#login_info').hide();
		
		var $table = $('<table border=0/>');    		
		$table.append('<tr><td>E-mail</td><td><input id="email_text" type="text" name="email" size="20"></td></tr>');
		$table.append('<tr><td>Password</td><td><input id="pass_password" type="password" name="pass" size="20"></td></tr>');
		$table.append('<tr><td colspan="2"><button id="submit_login_button">log in</button></td></tr>');	
		$('#list').html($table);
		
		$('#submit_login_button').click(function() {
			var login_url = "/associations/rest/login";
			var email = $('#email_text').val();

			$.ajax({
		    	url: login_url,
		    	type: 'PUT',
		    	data: { email: email, pass: '' + CryptoJS.SHA1($('#pass_password').val()) },
		    	success: function(result) {
					alert("success: " + result);
					login_token = result;
					login_email = email;
					get_list();
					show_logininfo();
		    		$('#add_button').attr("disabled", false);

		    	},
		    	error: function (jqXHR, textStatus, errorThrown) {
	                 alert("error: " + jqXHR.responseText);
		     	}
			});
        });
	}
	
	
	// hide some stuff
	function hide() {
		$('#add_button').hide();
		$('#list_button').hide();
		$('#search_text').hide();
		$('#search_button').hide();		
	}
	
	// show some stuff
	function show() {
		$('#add_button').show();
		$('#list_button').show();
		$('#search_text').show();
		$('#search_button').show();		
	}
</script>
</head>
<body>
    <table border="0">
    	<tr>
    		<td colspan="4" align="right"><div id="login_info"></div></td>
    	</tr>
    	<tr>
    		<td><button id="add_button">add example</button></td>
    		<td><button id="list_button">show all examples</button></td>
    		<td>&nbsp;&nbsp;&nbsp;</td>
    		<td align="right"><input type="text" id="search_text" size=20><button id="search_button">search</button></td>
    	</tr>
    	<tr>
    		<td colspan="4"><div id="list"></div></td>
    	</tr>
    </table>
	
</body>
</html>